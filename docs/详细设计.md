# ClassWeaver 详细设计（V3）

## 1. 架构
- 前端：Vue 3 + Vite + Tailwind。页面：Home、Knowledge、Coach、Take、Print、History、Login/Register。状态通过 localStorage/sessionStorage 及 URL state 维持。
- 后端：Django REST Framework。模块：
  - `src/agents/`：Planner/Rewrite/Tutor 提示与调用。
  - `src/kb/`：知识库上传、切片、向量存储（FAISS）。
  - `src/api/`：REST 视图（预课、知识库、测验、时间线、推荐、鉴权）。
  - `src/services/`：打印、PPT 解析、推荐、评分等。
- 存储：MySQL + 本地向量库（FAISS）。索引文件位于 `data/`，已被忽略。

## 2. 模块与接口
- 预课：`/api/prestudy/from-text|from-ppt` 创建任务；`/api/prestudy/<id>` 取结果；`/api/jobs/<id>` 轮询状态。
- 知识库：`/api/kb/bases/` 列表/创建/删除库；`/api/kb/upload/` 上传；`/api/kb/search/` 检索；`/api/kb/documents/` 列表/删除；`/api/kb/documents/<doc_id>/` 删除单个。
- 测验：`/api/quiz/start` 生成会话；`/api/quiz/submit` 评分。
- 时间线：`/api/lesson/<plan_id>/timeline` 获取事件；`/api/lesson/<plan_id>/events/` 记录事件。
- 推荐：`/api/recommendations/` 生成行动建议。
- 鉴权：`/api/auth/register|login|logout|me`，Session+CSRF。

## 3. 关键实现
- 知识库检索：上传切片入库与向量；检索时先大范围召回，再按 base/doc 过滤，保证只返回当前库。
- 任务流水线：Planner→Rewriter→Tutor，输出知识点、测验、练习、printable；结果写入 `PrestudyJob` 与 `LessonPlan`。
- 时间线：事件与推荐写入 `LessonEvent`，前端单列滚动，卡片拖拽时整块移动并重排顺序。
- 登录态：前端缓存用户，任意接口 401 时清空缓存，路由守卫跳转登录。

## 4. 数据模型（核心）
- `KnowledgeBase` / `KnowledgeDocument` / `KnowledgeChunk`
- `PrestudyJob` / `LessonPlan` / `LessonEvent`
- `QuizSession` / `QuizAnswer`
- `RecommendationTask`

## 5. 前端要点
- API 客户端统一注入 `Accept-Language: zh-CN`，携带 CSRF；401 时清理登录缓存。
- 本地存储：任务/对话在 localStorage，测验会话与提醒去重在 sessionStorage。
- 时间线滚动区设定最小高度，拖拽时高亮 ring/scale。

## 6. 部署与配置
- 环境变量：MySQL 连接、`API_KEY`、模型名、FAISS 索引路径。
- 静态资源：前端 `npm run build` 生成 dist，可由 Django 或前置静态服务器托管。
- 安全：默认未启用 Django admin；仅 Session 认证，未暴露 token。***
